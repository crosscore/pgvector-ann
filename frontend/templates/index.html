<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Similar TOC Search</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <header>
        <button id="theme-toggle">Theme Switch</button>
        <h1>Similar TOC Search</h1>
    </header>

    <main>
        <div class="display-mode-container">
            <label class="switch" for="display-mode-toggle">
                <input type="checkbox" id="display-mode-toggle">
                <span class="slider"></span>
            </label>
            <span id="display-mode-label">Inline Display</span>
        </div>

        <div class="search-container">
            <input type="text" id="searchQuestion" placeholder="Enter your question">
            <input type="number" id="topN" value="20" min="1" max="100" title="Number of top results">
            <input type="number" id="scoreThreshold" value="1" min="-1" max="2" step="0.1" title="Score threshold">
            <button id="search-button">Search</button>
        </div>

        <div id="results"></div>
    </main>

    <script>
        let displayMode = 'inline';
        let socket;
        const backendUrl = window.location.origin.replace('8000', '8001');

        function initializeTheme() {
            const themeToggle = document.getElementById('theme-toggle');
            const theme = localStorage.getItem('theme') || 'dark';

            if (theme === 'light') {
                document.body.classList.add('light-mode');
            }

            themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('light-mode');
                const newTheme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
            });
        }

        function initializeWebSocket() {
            socket = new WebSocket(`ws://${window.location.host}/ws`);
            const resultsDiv = document.getElementById('results');

            socket.onopen = function(event) {
                console.log("WebSocket connection opened");
            };

            socket.onmessage = function(event) {
                console.log("Received message from server:", event.data);
                const data = JSON.parse(event.data);

                if (data.error) {
                    console.error("Error received:", data.error);
                    resultsDiv.innerHTML = `<p>Error: ${data.error}</p>`;
                    return;
                }

                if (Array.isArray(data.results)) {
                    console.log("Processing search results:", data.results);
                    displayResults(data.results);
                } else {
                    console.error('Unexpected data format:', data);
                    resultsDiv.innerHTML = '<p>Error: Unexpected data format received</p>';
                }
            };

            socket.onerror = function(error) {
                console.error("WebSocket error:", error);
            };

            socket.onclose = function(event) {
                console.log("WebSocket connection closed:", event);
            };
        }

        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            let resultsHtml = '<h2>Search Results:</h2>';
            results.forEach((result, index) => {
                const pdfUrl = `${backendUrl}/pdf/${result.file_name}`;
                resultsHtml += `
                    <div class="result-item">
                        <h3>${index + 1}.
                            <a href="${pdfUrl}" target="_blank">${result.link_text}</a>
                        </h3>
                        <p>Distance: ${result.distance.toFixed(4)} (lower is more similar)</p>
                        <div class="content" style="display: none;"><pre>${result.chunk_text}</pre></div>
                        <button onclick="toggleChunkText(this)">Show Content</button>
                    </div>
                `;
            });
            resultsDiv.innerHTML = resultsHtml;
        }

        function toggleChunkText(button) {
            const contentDiv = button.previousElementSibling;
            if (contentDiv.style.display === 'none') {
                contentDiv.style.display = 'block';
                button.textContent = 'Hide Chunk Text';
            } else {
                contentDiv.style.display = 'none';
                button.textContent = 'Show Chunk Text';
            }
        }

        function search() {
            const question = document.getElementById('searchQuestion').value;
            const topN = parseInt(document.getElementById('topN').value);
            const scoreThreshold = parseFloat(document.getElementById('scoreThreshold').value);
            document.getElementById('results').innerHTML = 'Searching...';
            console.log("Sending search request:", { question, top_n: topN, score_threshold: scoreThreshold });

            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ question, top_n: topN, score_threshold: scoreThreshold }));
            } else {
                console.error("WebSocket is not open. Reconnecting...");
                initializeWebSocket();
                setTimeout(() => {
                    if (socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({ question, top_n: topN, score_threshold: scoreThreshold }));
                    } else {
                        console.error("Failed to reconnect WebSocket");
                        document.getElementById('results').innerHTML = 'Error: Unable to connect to server';
                    }
                }, 1000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            initializeWebSocket();

            const displayModeToggle = document.getElementById('display-mode-toggle');
            const displayModeLabel = document.getElementById('display-mode-label');
            const searchButton = document.getElementById('search-button');

            displayModeToggle.addEventListener('change', () => {
                displayMode = displayModeToggle.checked ? 'new-tab' : 'inline';
                displayModeLabel.textContent = displayMode === 'inline' ? 'Inline Display' : 'Open in new tab';
            });

            searchButton.addEventListener('click', search);
        });
    </script>
</body>
</html>
